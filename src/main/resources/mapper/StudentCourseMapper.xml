<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="mapper.StudentCourseMapper">

    <resultMap id="StudentCourseDetailResultMap" type="view.StudentCourseDetailVO">
        <id property="teachingId" column="teaching_id"/>
        <result property="maxCapacity" column="max_capacity"/>
        <result property="currentStudents" column="current_students"/>
        <result property="weeks" column="weeks"/>
        <result property="weekday" column="weekday"/>
        <result property="classPeriod" column="class_period"/>
        <result property="location" column="location"/>
        <result property="semester" column="semester"/>

        <result property="score" column="score"/>
        <result property="status" column="status"/>
        <result property="enrollmentType" column="enrollment_type"/>
        <association property="course" javaType="entity.course.Course">
            <id property="courseId" column="c_course_id"/>
            <result property="courseName" column="course_name"/>
            <result property="credits" column="credits"/>
            <association property="major" javaType="entity.schoolroll.Major">
                <id property="majorId" column="major_id"/>
                <result property="majorName" column="major_name"/>
            </association>
        </association>
        <association property="teacher" javaType="entity.course.Teacher">
            <id property="teacherId" column="t_teacher_id"/>
            <result property="teacherName" column="teacher_name"/>
            <result property="title" column="title"/>
        </association>
    </resultMap>
    <resultMap id="TeacherCourseResultMap" type="entity.course.TeacherCourse">
        <!-- 主键映射 -->
        <id property="teachingId" column="teaching_id"/>
        <!-- 普通字段映射 -->
        <result property="courseId" column="course_id"/>
        <result property="teacherId" column="teacher_id"/>
        <result property="maxCapacity" column="max_capacity"/>
        <result property="currentStudents" column="current_students"/>
        <result property="weeks" column="weeks"/>
        <result property="weekday" column="weekday"/>
        <result property="classPeriod" column="class_period"/>
        <result property="location" column="location"/>
        <result property="semester" column="semester"/>
    </resultMap>


    <!-- [新增] 检查学生在 *指定学期* 是否已经选修了某门课程 (用于防止重复选课) -->
    <select id="countEnrollmentsInSemester" resultType="java.lang.Integer">
        SELECT COUNT(*)
        FROM student_course sc
                 JOIN teacher_course tc ON sc.teaching_id = tc.teaching_id
        WHERE sc.student_id = #{studentId}
          AND tc.course_id = #{courseId}
          AND tc.semester = #{semester}
          AND sc.status != '已退课'
    </select>

    <!-- [新增] 检查学生在 *过去学期* 是否有某门课程的“已完成”记录 (用于判断首修/重修) -->
    <select id="countCompletedCoursesInPastSemesters" resultType="java.lang.Integer">
        SELECT COUNT(*)
        FROM student_course sc
                 JOIN teacher_course tc ON sc.teaching_id = tc.teaching_id
        WHERE sc.student_id = #{studentId}
          AND tc.course_id = #{courseId}
          AND tc.semester != #{currentSemester}
          AND sc.status = '已完成'
    </select>

    <insert id="insertStudentCourse" parameterType="entity.course.StudentCourse">
        INSERT INTO student_course
            (student_id, teaching_id, enrollment_type, status)
        VALUES
            (#{studentId}, #{teachingId}, #{enrollmentType}, '正在学习')
    </insert>

    <delete id="deleteStudentCourse">
        DELETE FROM student_course
        WHERE student_id = #{studentId} AND teaching_id = #{teachingId}
    </delete>

    <select id="findSelectedCoursesByStudent" resultMap="StudentCourseDetailResultMap">
        SELECT
            tc.teaching_id, tc.max_capacity, tc.current_students, tc.weeks, tc.weekday,
            tc.class_period, tc.location, tc.semester,
            c.course_id as c_course_id, c.course_name, c.credits,
            t.teacher_id as t_teacher_id, t.teacher_name, t.title,
            sc.score, sc.status, sc.enrollment_type,
            m.major_id, m.major_name
        FROM
            student_course sc
                JOIN
            teacher_course tc ON sc.teaching_id = tc.teaching_id
                JOIN
            courses c ON tc.course_id = c.course_id
                JOIN
            teachers t ON tc.teacher_id = t.teacher_id
                JOIN
            majors m ON c.major_id = m.major_id
        WHERE
            sc.student_id = #{studentId} AND tc.semester = #{semester}
        ORDER BY
            tc.weekday, tc.class_period
    </select>

    <select id="findGradeHistoryByStudent" resultMap="StudentCourseDetailResultMap">
        SELECT
            tc.teaching_id, tc.max_capacity, tc.current_students, tc.weeks, tc.weekday,
            tc.class_period, tc.location, tc.semester,
            c.course_id as c_course_id, c.course_name, c.credits,
            t.teacher_id as t_teacher_id, t.teacher_name, t.title,
            sc.score, sc.status, sc.enrollment_type,
            m.major_id, m.major_name
        FROM
            student_course sc
                JOIN
            teacher_course tc ON sc.teaching_id = tc.teaching_id
                JOIN
            courses c ON tc.course_id = c.course_id
                JOIN
            teachers t ON tc.teacher_id = t.teacher_id
                JOIN
            majors m ON c.major_id = m.major_id
        WHERE
            sc.student_id = #{studentId}
        ORDER BY
            tc.semester DESC, c.course_id
    </select>

    <select id="findSchedulesByStudentAndSemester" resultMap="TeacherCourseResultMap">
        SELECT
            tc.teaching_id,
            tc.course_id,
            tc.teacher_id,
            tc.max_capacity,
            tc.current_students,
            tc.weeks,
            tc.weekday,
            tc.class_period,
            tc.location,
            tc.semester
        FROM
            student_course sc
                JOIN
            teacher_course tc ON sc.teaching_id = tc.teaching_id
        WHERE
            sc.student_id = #{studentId}
          AND tc.semester = #{semester}
          AND sc.status != '已退课'
    </select>

</mapper>