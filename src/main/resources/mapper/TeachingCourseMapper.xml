<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="mapper.TeachingCourseMapper">

    <resultMap id="CourseOfferingResultMap" type="view.CourseOfferingVO">
        <id property="teachingId" column="teaching_id"/>
        <result property="maxCapacity" column="max_capacity"/>
        <result property="currentStudents" column="current_students"/>
        <result property="weeks" column="weeks"/>
        <result property="weekday" column="weekday"/>
        <result property="classPeriod" column="class_period"/>
        <result property="location" column="location"/>
        <result property="semester" column="semester"/>

        <association property="course" javaType="entity.course.Course">
            <id property="courseId" column="c_course_id"/>
            <result property="courseName" column="course_name"/>
            <result property="credits" column="credits"/>

            <association property="major" javaType="entity.schoolroll.Major">
                <id property="majorId" column="major_id"/>
                <result property="majorName" column="major_name"/>
            </association>
        </association>

        <association property="teacher" javaType="entity.course.Teacher">
            <id property="teacherId" column="t_teacher_id"/>
            <result property="teacherName" column="teacher_name"/>
            <result property="title" column="title"/>
            <result property="contactInfo" column="contact_info"/>
        </association>
    </resultMap>

    <resultMap id="TeacherCourseResultMap" type="entity.course.TeacherCourse">
        <!-- 主键映射 -->
        <id property="teachingId" column="teaching_id"/>
        <!-- 普通字段映射 -->
        <result property="courseId" column="course_id"/>
        <result property="teacherId" column="teacher_id"/>
        <result property="maxCapacity" column="max_capacity"/>
        <result property="currentStudents" column="current_students"/>
        <result property="weeks" column="weeks"/>
        <result property="weekday" column="weekday"/>
        <result property="classPeriod" column="class_period"/>
        <result property="location" column="location"/>
        <result property="semester" column="semester"/>
    </resultMap>

    <select id="findAvailableCourses" resultMap="CourseOfferingResultMap">
        SELECT
        tc.teaching_id, tc.max_capacity, tc.current_students, tc.weeks, tc.weekday,
        tc.class_period, tc.location, tc.semester,
        c.course_id as c_course_id, c.course_name, c.credits,
        t.teacher_id as t_teacher_id, t.teacher_name, t.title, t.contact_info,
        m.major_id, m.major_name
        FROM
        teacher_course tc
        JOIN
        courses c ON tc.course_id = c.course_id
        JOIN
        teachers t ON tc.teacher_id = t.teacher_id
        JOIN
        majors m ON c.major_id = m.major_id
        <where>
        </where>
        ORDER BY c.course_id
    </select>

    <select id="findCourseNameByTeachingId" resultType="java.lang.String">
        SELECT
            c.course_name
        FROM
            teacher_course tc
        JOIN
            courses c ON tc.course_id = c.course_id
        WHERE
            tc.teaching_id = #{teachingId}
    </select>

    <select id="findTeacherCourseById" resultMap="TeacherCourseResultMap">
        SELECT * FROM teacher_course
        WHERE teaching_id = #{teachingId}
    </select>

    <update id="incrementStudentCount">
        UPDATE teacher_course
        SET current_students = current_students + 1
        WHERE teaching_id = #{teachingId} AND current_students &lt; max_capacity
    </update>

    <update id="decrementStudentCount">
        UPDATE teacher_course
        SET current_students = current_students - 1
        WHERE teaching_id = #{teachingId} AND current_students > 0
    </update>

</mapper>