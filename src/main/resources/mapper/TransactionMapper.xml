<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="mapper.TransactionMapper">

    <resultMap id="TransactionResultMap" type="entity.bank.Transaction">
        <id property="transactionId" column="transaction_id"/>
        <result property="fromAccount" column="from_account"/>
        <result property="toAccount" column="to_account"/>
        <result property="amount" column="amount"/>
        <result property="type" column="type"/>
        <result property="timestamp" column="timestamp"/>
        <result property="memo" column="memo"/>
    </resultMap>

    <!-- 注意：字段名从 fromAccount/toAccount 映射到 from_account_id/to_account_id -->
    <insert id="insert" parameterType="entity.bank.Transaction" useGeneratedKeys="true" keyProperty="transactionId">
        INSERT INTO transactions (from_account_id, to_account_id, amount, type, timestamp, memo)
        VALUES (#{fromAccount}, #{toAccount}, #{amount}, #{type}, #{timestamp}, #{memo})
    </insert>

    <!--
      查询逻辑：一个账户的交易记录，可能是作为转出方(from_account_id)也可能是作为转入方(to_account_id)，
      所以查询条件需要使用 OR。
    -->
    <select id="findByAccountIdAndTime" resultMap="TransactionResultMap">
        SELECT
        transaction_id, from_account_id as from_account, to_account_id as to_account,
        amount, type, timestamp, memo
        FROM
        transactions
        <where>
            (from_account_id = #{accountId} OR to_account_id = #{accountId})
            <if test="start != null">
                AND timestamp >= #{start}
            </if>
            <if test="end != null">
                AND timestamp &lt;= #{end}
            </if>
        </where>
        ORDER BY
        timestamp DESC
    </select>

</mapper>
